<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Statistiques Codestan</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .card { margin-bottom: 2rem; }
    .card-header { font-weight: bold; }
    th, td { text-align: center; }
    #chart-container {
      max-width: 900px;
      margin: auto;
      margin-bottom: 2rem;
    }
  </style>
</head>

<body class="container mt-5">
  <h1 class="mb-4 text-center">📊 Vos statistiques détaillées, {{ user_data.name | capitalize }}</h1>

  <!-- 🟢 Chart Panel -->
  <div id="chart-container" class="card">
    <div class="card-header text-center">📈 Évolution de votre score</div>
    <div class="card-body">
      <canvas id="mainChart" height="120"></canvas>
    </div>
  </div>

  <!-- Global Stats -->
  <div class="card">
    <div class="card-header">🧠 Statistiques générales</div>
    <div class="card-body">
      <p><strong>Score total :</strong> {{ user_data.score }}</p>
      <p><strong>Réussite globale :</strong> {{ user_data.success_rate_overall }}%</p>
      <p><strong>Temps passé :</strong> {{ user_data.time_spent_minutes }} minutes</p>
      <p><strong>Réponses totales :</strong> {{ user_data.total_answered }}</p>
      <p><strong>Meilleure série :</strong> {{ user_data.best_streak }}</p>
    </div>
  </div>

  <!-- Daily Stats Table -->
  <div class="card">
    <div class="card-header">📅 Statistiques quotidiennes</div>
    <div class="card-body table-responsive">
      <table class="table table-sm table-striped">
        <thead class="table-light">
          <tr>
            <th>Date</th>
            <th>Réponses</th>
            <th>Bonnes</th>
            <th>Mauvaises</th>
            <th>Score</th>
            <th>Taux de réussite</th>
          </tr>
        </thead>
        <tbody>
          {% for day, stats in user_data.daily_stats.items() | sort %}
          <tr>
            <td>{{ day }}</td>
            <td>{{ stats.answered }}</td>
            <td>{{ stats.correct }}</td>
            <td>{{ stats.wrong }}</td>
            <td>{{ stats.score }}</td>
            <td>{{ stats.success_rate }}%</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Monthly Stats -->
  <div class="card">
    <div class="card-header">📆 Statistiques mensuelles</div>
    <div class="card-body table-responsive">
      <table class="table table-sm table-striped">
        <thead class="table-light">
          <tr>
            <th>Mois</th>
            <th>Réponses</th>
            <th>Bonnes</th>
            <th>Mauvaises</th>
            <th>Score</th>
            <th>Taux de réussite</th>
          </tr>
        </thead>
        <tbody>
          {% for month, stats in user_data.monthly_stats.items() | sort %}
          <tr>
            <td>{{ month }}</td>
            <td>{{ stats.answered }}</td>
            <td>{{ stats.correct }}</td>
            <td>{{ stats.wrong }}</td>
            <td>{{ stats.score }}</td>
            <td>{{ stats.success_rate }}%</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Theme Stats -->
  <div class="card">
    <div class="card-header">🧩 Statistiques par thème</div>
    <div class="card-body table-responsive">
      <table class="table table-sm table-striped">
        <thead class="table-light">
          <tr>
            <th>Thème</th>
            <th>Réponses</th>
            <th>Bonnes</th>
            <th>Mauvaises</th>
            <th>Taux de réussite</th>
          </tr>
        </thead>
        <tbody>
          {% for theme, stats in user_data.theme_stats.items() %}
          <tr>
            <td>{{ theme }}</td>
            <td>{{ stats.answered }}</td>
            <td>{{ stats.correct }}</td>
            <td>{{ stats.wrong }}</td>
            <td>
              {% if stats.answered > 0 %}
                {{ (100 * stats.correct / stats.answered) | round(1) }}%
              {% else %}
                N/A
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Incorrect Questions -->
  <div class="card">
    <div class="card-header">❌ Questions à revoir</div>
    <div class="card-body">
      {% if user_data.incorrect_questions %}
        <p>Tu as encore {{ user_data.incorrect_questions | length }} question(s) à revoir :</p>
        <ul>
          {% for qid in user_data.incorrect_questions %}
          <li>{{ qid }}</li>
          {% endfor %}
        </ul>
      {% else %}
        <p>👏 Tu n'as actuellement aucune question à revoir !</p>
      {% endif %}
    </div>
  </div>

  <!-- Return -->
  <div class="text-center">
    <a href="{{ url_for('profile') }}" class="btn btn-primary mt-3">⬅️ Retour au profil</a>
  </div>

  <!-- ✅ Chart loader script -->
  <script>
    const ctx = document.getElementById('mainChart').getContext('2d');

    const chartLabels = [];
    const chartScores = [];

    const rawStats = {{ user_data.daily_stats | tojson }};

    // Sort and push values
    Object.keys(rawStats).sort().forEach(date => {
      chartLabels.push(date);
      chartScores.push(rawStats[date].score);
    });

    const mainChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: chartLabels,
        datasets: [{
          label: 'Score par jour',
          data: chartScores,
          fill: false,
          borderColor: 'rgb(75, 192, 192)',
          tension: 0.2,
          pointRadius: 4,
          pointHoverRadius: 6
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: true }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              stepSize: 1
            }
          }
        }
      }
    });
  </script>
</body>
</html>
