<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Profil Codestan</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    .avatar-img {
      max-height: 120px;
      border-radius: 50%;
    }
    .stat-label {
      font-weight: bold;
    }
    .card-body p {
      margin-bottom: 0.6rem;
    }
    .avatar-option input[type="radio"] {
      display: none;
    }
    .avatar-option img {
      height: 70px;
      width: 70px;
      border-radius: 50%;
      cursor: pointer;
      transition: transform 0.2s;
      border: 2px solid transparent;
    }
    .avatar-option img:hover {
      transform: scale(1.1);
      border-color: #007bff;
    }
  </style>
</head>

<body class="container mt-5">

  <!-- Header with logout -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0">
      👋 Bonjour, {{ user_data.avatar_name or user_data.name | capitalize or user_data.email }}
    </h1>
    <a href="{{ url_for('logout') }}" class="btn btn-outline-secondary">Se déconnecter</a>
  </div>
  <p class="text-muted">Compte : {{ user_data.email }}</p>

  <div class="row">
    <!-- LEFT: Avatar + Mode Selection -->
    <div class="col-md-6 mb-4">
      <div class="card mb-4">
        <div class="card-header text-center">Votre Avatar</div>
        <div class="card-body text-center">
          <img src="{{ url_for('static', filename='avatars/' ~ (user_data.avatar or 'default.png')) }}" alt="avatar" class="avatar-img mb-2">
          <p>
            <button class="btn btn-sm btn-outline-primary" type="button" onclick="toggleAvatarGrid()">Changer d’avatar</button>
          </p>

          <div id="avatar-grid" style="display: none;">
            <form method="POST" action="{{ url_for('update_avatar') }}">
              <div class="d-flex flex-wrap justify-content-center gap-2 mb-3">
                {% for avatar in avatars %}
                <label class="avatar-option">
                  <input type="radio" name="avatar" value="{{ avatar }}" {% if avatar == user_data.avatar %}checked{% endif %}>
                  <img src="{{ url_for('static', filename='avatars/' ~ avatar) }}" alt="avatar">
                </label>
                {% endfor %}
              </div>
              <button type="submit" class="btn btn-success btn-sm">Mettre à jour</button>
              <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleAvatarGrid()">Annuler</button>
            </form>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header text-center">Quelle est la raison de votre visite ?</div>
        <div class="card-body">
          <form method="POST" action="{{ url_for('set_mode') }}">
            <button type="submit" name="mode" value="libre" class="btn btn-success w-100 mb-3">
              🎓 Réaliser un entraînement libre
            </button>
            <button type="submit" name="mode" value="themes_faibles" class="btn btn-warning w-100 mb-3">
              📉 M’entraîner sur mes plus mauvais thèmes
            </button>
            <button type="submit" name="mode" value="reviser" class="btn btn-info w-100">
              🧠 Réviser mes erreurs
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- RIGHT: Stats -->
    <div class="col-md-6">
      <div class="card mb-3">
        <div class="card-header text-center">📊 Statistiques Générales</div>
        <div class="card-body">
          <p><span class="stat-label">Score total :</span> {{ user_data.score }}</p>
          <p><span class="stat-label">Réussite globale :</span> {{ user_data.success_rate_overall }}%</p>
          <p><span class="stat-label">Questions répondues :</span> {{ user_data.total_answered }}</p>
          <p><span class="stat-label">Série actuelle :</span> {{ user_data.current_streak }}</p>
          <p><span class="stat-label">Meilleure série :</span> {{ user_data.best_streak }}</p>
          <p><span class="stat-label">Série de connexions en cours :</span> {{ user_data.get("login_streak", {}).get("count", 0) }} jours</p>
          <p><span class="stat-label">Meilleure série de connexions :</span> {{ user_data.get("login_streak", {}).get("best", 0) }} jours</p>

          {% if user_data.best_theme %}
            <p><span class="stat-label">Thème fort :</span> {{ user_data.best_theme }}</p>
          {% else %}
            <p><span class="stat-label">Thème fort :</span> N/A</p>
          {% endif %}

          {% if user_data.worst_theme %}
            <p><span class="stat-label">Thème faible :</span> {{ user_data.worst_theme }}</p>
          {% else %}
            <p><span class="stat-label">Thème faible :</span> N/A</p>
          {% endif %}

          <p><span class="stat-label">Temps passé :</span> {{ user_data.time_spent_minutes }} min</p>
        </div>

        <!-- Stats Button -->
        <div class="card-footer text-center px-3">
          <a href="{{ url_for('stats') }}" class="btn btn-outline-secondary w-100">
            📊 Voir mes statistiques détaillées
          </a>
        </div>
      </div>
    </div>
  </div> <!-- END .row -->

  <script>
    function toggleAvatarGrid() {
      const grid = document.getElementById("avatar-grid");
      grid.style.display = grid.style.display === "none" ? "block" : "none";
    }
  </script>
</body>
</html>
